<!DOCTYPE html>
<html>
<head>
<title>OBBY ONLINE</title>
<style>
body { margin:0; overflow:hidden; font-family:Arial; }
canvas { display:block; }

/* Ð­ÐºÑ€Ð°Ð½ Ð½Ð¸ÐºÐ° */
#nicknameScreen {
  position: fixed;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display:flex;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  color:white;
  z-index:1000;
}

#nicknameScreen input {
  padding:10px;
  font-size:18px;
}

/* Ð§Ð°Ñ‚ */
#chatToggle {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: 50px;
  height: 50px;
  background: rgba(0,0,0,0.6);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  cursor: pointer;
}

#chatContainer {
  position: fixed;
  bottom: 80px;
  left: 20px;
  width: 300px;
  background: rgba(0,0,0,0.6);
  padding: 10px;
  border-radius: 12px;
  display: none;
  color: white;
}

#chatBox {
  max-height:150px;
  overflow-y:auto;
  margin-bottom:5px;
}
</style>
</head>
<body>

<div id="nicknameScreen">
  <h2>Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¸Ðº</h2>
  <input id="nicknameInput" placeholder="Ð’Ð°Ñˆ Ð½Ð¸Ðº">
  <button onclick="startGame()">Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ</button>
</div>

<div id="chatToggle">ðŸ’¬</div>
<div id="chatContainer">
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ">
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>

<script>
const socket = io();
let nickname = "";

function startGame(){
  nickname = document.getElementById("nicknameInput").value.trim();
  if(!nickname) return;
  document.getElementById("nicknameScreen").style.display="none";
  socket.emit("newPlayer",{nickname});
}

/* ===== THREE ===== */

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);

const camera = new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.6));
const light=new THREE.DirectionalLight(0xffffff,1);
light.position.set(5,10,5);
scene.add(light);

/* ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹ */

const platforms=[];
function platform(x,y,z,w,h,d,color){
  const m=new THREE.Mesh(
    new THREE.BoxGeometry(w,h,d),
    new THREE.MeshStandardMaterial({color})
  );
  m.position.set(x,y,z);
  scene.add(m);
  platforms.push(m);
}

platform(0,0,0,10,1,10,0x888888);
platform(0,3,-10,4,1,4,0xffaa00);
platform(5,6,-20,4,1,4,0xffaa00);
platform(-5,9,-30,4,1,4,0xffaa00);
platform(0,12,-40,4,1,4,0x00ff00);

/* Ð˜Ð³Ñ€Ð¾Ðº */

const player=new THREE.Mesh(
  new THREE.BoxGeometry(1,2,1),
  new THREE.MeshStandardMaterial({color:0xff0000})
);
player.position.set(0,2,0);
scene.add(player);

function createNicknameLabel(text){
  const canvas=document.createElement("canvas");
  const ctx=canvas.getContext("2d");
  canvas.width=256; canvas.height=64;
  ctx.fillStyle="white";
  ctx.font="30px Arial";
  ctx.fillText(text,10,40);
  const texture=new THREE.CanvasTexture(canvas);
  const material=new THREE.SpriteMaterial({map:texture});
  const sprite=new THREE.Sprite(material);
  sprite.scale.set(4,1,1);
  return sprite;
}

const myLabel=createNicknameLabel("You");
myLabel.position.y=2;
player.add(myLabel);

/* ÐœÑƒÐ»ÑŒÑ‚Ð¸Ð¿Ð»ÐµÐµÑ€ */

const others={};

socket.on("currentPlayers",(players)=>{
  for(let id in players){
    if(id!==socket.id){
      addOther(id,players[id]);
    }
  }
});

socket.on("newPlayer",(data)=>{
  addOther(data.id,data.player);
});

socket.on("playerMoved",(data)=>{
  if(others[data.id]){
    others[data.id].mesh.position.set(
      data.player.x,
      data.player.y,
      data.player.z
    );
  }
});

socket.on("playerDisconnected",(id)=>{
  if(others[id]){
    scene.remove(others[id].mesh);
    delete others[id];
  }
});

function addOther(id,data){
  const mesh=new THREE.Mesh(
    new THREE.BoxGeometry(1,2,1),
    new THREE.MeshStandardMaterial({color:0x00ff00})
  );
  mesh.position.set(data.x,data.y,data.z);

  const label=createNicknameLabel(data.nickname);
  label.position.y=2;
  mesh.add(label);

  scene.add(mesh);
  others[id]={mesh};
}

/* Ð§ÐÐ¢ + Ð—Ð’Ð£Ðš */

const chatBox=document.getElementById("chatBox");
const chatInput=document.getElementById("chatInput");
const chatContainer=document.getElementById("chatContainer");
const chatToggle=document.getElementById("chatToggle");

const audio=new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

chatToggle.onclick=()=>chatContainer.style.display="block";

chatInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && chatInput.value.trim()){
    socket.emit("chatMessage",chatInput.value);
    chatInput.value="";
  }
});

socket.on("chatMessage",(data)=>{
  chatContainer.style.display="block";
  const div=document.createElement("div");
  div.textContent=data.nickname+": "+data.message;
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
  audio.play();
});

/* Ð¤Ð˜Ð—Ð˜ÐšÐ */

let velocityY=0;
let onGround=false;
const gravity=-0.01;
const jumpPower=0.25;

const keys={};

document.addEventListener("keydown",e=>keys[e.code]=true);
document.addEventListener("keyup",e=>keys[e.code]=false);

function checkCollision(){
  onGround=false;
  for(let p of platforms){
    const dx=Math.abs(player.position.x-p.position.x);
    const dz=Math.abs(player.position.z-p.position.z);
    if(dx<p.geometry.parameters.width/2 &&
       dz<p.geometry.parameters.depth/2){
      const top=p.position.y+0.5;
      if(player.position.y-1<=top &&
         player.position.y-1>=top-0.5){
        player.position.y=top+1;
        velocityY=0;
        onGround=true;
      }
    }
  }
}

function animate(){
  requestAnimationFrame(animate);

  const speed=0.15;

  if(keys["KeyW"]) player.position.z-=speed;
  if(keys["KeyS"]) player.position.z+=speed;
  if(keys["KeyA"]) player.position.x-=speed;
  if(keys["KeyD"]) player.position.x+=speed;

  if(keys["Space"] && onGround) velocityY=jumpPower;

  velocityY+=gravity;
  player.position.y+=velocityY;

  checkCollision();

  if(player.position.y<-20){
    player.position.set(0,2,0);
    velocityY=0;
  }

  camera.position.set(
    player.position.x,
    player.position.y+6,
    player.position.z+10
  );
  camera.lookAt(player.position);

  socket.emit("updatePosition",{
    x:player.position.x,
    y:player.position.y,
    z:player.position.z
  });

  renderer.render(scene,camera);
}

animate();
</script>
</body>
</html>
